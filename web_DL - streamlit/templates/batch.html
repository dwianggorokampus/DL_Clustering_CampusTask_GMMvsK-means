{% extends "base.html" %}

{% block content %}
<section class="hero" style="padding: 2rem 0;">
    <h1>Batch Prediction</h1>
    <p>Upload a CSV or Excel file to segment multiple customers at once.</p>
    <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 0.5rem;">
        <strong>Note:</strong> This tool uses the <strong>K-Means</strong> clustering model to process the data.
    </p>
</section>

<div style="max-width: 800px; margin: 0 auto;">
    <div class="card"
        style="background: rgba(var(--primary-rgb), 0.1); border: 1px solid var(--glass-border); padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">ℹ️ File Format Guide</h3>
        <p style="font-size: 0.9rem; color: var(--text-muted); margin: 0;">
            Upload a CSV or Excel file containing transaction data. The system will calculate RFM metrics for each
            customer.
        </p>
        <div
            style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-muted); background: rgba(255,255,255,0.05); padding: 0.5rem; border-radius: 4px;">
            <strong>Required Columns:</strong><br>
            <code>InvoiceDate</code>, <code>Quantity</code>, <code>UnitPrice</code>, <code>InvoiceNo</code>,
            <code>CustomerID</code>
        </div>
    </div>

    <div class="card">
        <form method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label for="snapshot_type">Snapshot Date (for Recency calculation)</label>
                <select id="snapshot_type" name="snapshot_type" onchange="toggleSnapshotDate()">
                    <option value="today">Use Today's Date</option>
                    <option value="custom">Custom Date</option>
                </select>
                <input type="date" id="snapshot_date" name="snapshot_date" style="display: none; margin-top: 0.5rem;">
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                    For historical data (e.g., 2011 data), use a custom date close to the transaction dates (e.g.,
                    2011-12-31).
                </p>
            </div>

            <div class="form-group">
                <label for="model_type">Select Clustering Model</label>
                <select id="model_type" name="model_type">
                    <option value="kmeans">K-Means (Default)</option>
                    <option value="gmm">Gaussian Mixture Model (GMM)</option>
                </select>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                    Choose the algorithm to use for segmentation.
                </p>
            </div>

            <div class="form-group">
                <label for="file">Upload File (CSV or Excel)</label>
                <input type="file" id="file" name="file" accept=".csv, .xlsx, .xls" required
                    style="padding: 2rem; border: 2px dashed var(--glass-border); text-align: center;">
            </div>
            <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem;">
                <strong>Supported Formats:</strong><br>
                1. <strong>Raw Transaction Data</strong>: Must include <code>InvoiceDate</code>, <code>Quantity</code>,
                <code>UnitPrice</code>, <code>InvoiceNo</code>, <code>CustomerID</code>.<br>
                2. <strong>Pre-calculated RFM</strong>: Must include <code>Recency</code>, <code>Frequency</code>,
                <code>Monetary</code>.
            </p>
            <button type="submit" class="btn" style="width: 100%;">Process Batch</button>
        </form>
    </div>

    {% if error %}
    <div class="result-box" style="border-color: #ff4757;">
        <h3 style="color: #ff4757;">Error</h3>
        <p>{{ error }}</p>
    </div>
    {% endif %}

    {% if download_link %}
    <div class="result-box">
        <h3>Processing Complete!</h3>
        <p>Your data has been segmented using <strong>{{ model_name }}</strong>.</p>

        <div
            style="background: rgba(var(--primary-rgb), 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid var(--primary-color);">
            <h4 style="margin-top: 0; color: var(--primary-color);">Optimization Score</h4>
            <p style="font-size: 1.2rem; font-weight: bold; margin: 0.5rem 0;">Silhouette Score: {{ silhouette_score }}
            </p>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0;">
                * Higher score indicates better defined clusters (Range: -1 to 1).<br>
                * Note: Score is only calculated if there are at least 2 distinct clusters and sufficient data points.
            </p>

            {% if "N/A" in silhouette_score %}
            <button onclick="toggleExplanation()"
                style="background: none; border: none; color: var(--primary-color); text-decoration: underline; cursor: pointer; font-size: 0.8rem; padding: 0; margin-top: 0.5rem;">
                (Show more explanation)
            </button>
            <div id="score-explanation"
                style="display: none; margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted); background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 4px;">
                <strong>Why is the score N/A?</strong><br>
                This usually happens when the model assigns <strong>all customers to the same group</strong> (e.g.,
                everyone is "Inactive").<br><br>
                <strong>Is it still grouped?</strong><br>
                Yes! The model successfully processed your data, but it found that all customers look similar enough to
                belong to a single cluster. This is common with random or uniform test data.<br><br>
                <strong>How to fix?</strong><br>
                Try using real transaction data with more variety in customer behavior (some high spenders, some low
                spenders, etc.).
            </div>
            {% endif %}
        </div>

        <a href="{{ url_for('download_file', filename=download_link) }}" class="btn" style="margin-top: 1rem;">Download
            Results</a>
    </div>
    {% endif %}

    {% if tables %}
    <div style="margin-top: 2rem; overflow-x: auto;">
        <h3>Preview</h3>
        {% for table in tables %}
        {{ table|safe }}
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
    function toggleSnapshotDate() {
        const snapshotType = document.getElementById('snapshot_type').value;
        const snapshotDateInput = document.getElementById('snapshot_date');
        if (snapshotType === 'custom') {
            snapshotDateInput.style.display = 'block';
            snapshotDateInput.required = true;
        } else {
            snapshotDateInput.style.display = 'none';
            snapshotDateInput.required = false;
        }
    }

    function toggleExplanation() {
        var x = document.getElementById("score-explanation");
        if (x.style.display === "none") {
            x.style.display = "block";
        } else {
            x.style.display = "none";
        }
    }
</script>
{% endblock %}